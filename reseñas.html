<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reseñas de Clientes - Byte</title>
    <link rel="icon" href="./images/favicon.png" type="image/x-icon">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@700;800;900&family=Lora:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@700;800;900&family=Lora:wght@400;700&display=swap"></noscript>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script type="module">
        // Importar las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                        vision: ['Lora', 'serif'],
                    },
                    colors: {
                        'byte-dark-bg': '#0A0A1A',
                        'byte-accent-cyan': '#00FFFF',
                        'byte-light-bg': '#F8FAFC',
                        'byte-text-dark': '#374151',
                        'byte-text-light': '#F9FAFB',
                        'byte-secondary-dark': '#1A202C',
                    }
                }
            }
        }

        let db;
        let auth;
        let userId;
        let isAuthReady = false; // Flag para indicar si la autenticación está lista

        // !!! IMPORTANTE: En una aplicación real, NO hardcodees el ID de administrador.
        // Implementa un sistema de autenticación y roles adecuado.
        // Para propósitos de demostración, puedes obtener tu propio userId de Firebase Console
        // después de iniciar sesión anónimamente y pegarlo aquí.
        const adminUserId = "YOUR_ADMIN_FIREBASE_UID_HERE"; // <--- REEMPLAZA ESTO CON UN UID REAL DE PRUEBA

        // Función para verificar el lenguaje inapropiado usando la API de Gemini
        async function checkForProfanity(text) {
            const prompt = `Analyze the following text for profanity, insults, or inappropriate language. Respond with "CLEAN" if no such language is found, otherwise respond with "FLAGGED". Text: "${text}"`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Dejar como está, Canvas lo proporcionará
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const responseText = result.candidates[0].content.parts[0].text.trim().toUpperCase();
                    return responseText === "FLAGGED";
                } else {
                    console.warn("Unexpected API response structure for profanity check:", result);
                    return false; // Por defecto, si la respuesta de la API es inesperada
                }
            } catch (error) {
                console.error("Error calling Gemini API for profanity check:", error);
                return false; // Por defecto, si la llamada a la API falla
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar Firebase
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Escuchar cambios en el estado de autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Si no hay usuario, iniciar sesión de forma anónima
                    try {
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                    } catch (error) {
                        console.error("Error al iniciar sesión anónimamente:", error);
                        document.getElementById('reviews-list').innerHTML = `<p class="text-red-500 text-center">No se pudieron cargar las reseñas. Por favor, intenta de nuevo más tarde.</p>`;
                        return;
                    }
                }
                isAuthReady = true; // La autenticación está lista
                loadReviews(); // Cargar las reseñas una vez que la autenticación esté lista
            });

            const reviewForm = document.getElementById('review-form');
            const reviewsList = document.getElementById('reviews-list');
            const ratingInputs = document.querySelectorAll('input[name="rating"]');
            const messageBox = document.getElementById('message-box');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');
            let reviewToDeleteId = null; // Para almacenar el ID de la reseña a eliminar

            let currentRating = 0;

            // Manejo de la selección de estrellas
            ratingInputs.forEach(input => {
                input.addEventListener('change', (event) => {
                    currentRating = parseInt(event.target.value);
                });
            });

            // Manejo del envío del formulario
            if (reviewForm) {
                reviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!isAuthReady) {
                        console.warn("Autenticación no lista. Intentando enviar reseña más tarde.");
                        messageBox.innerHTML = `<p class="text-yellow-500">Por favor, espera mientras se carga la autenticación.</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);
                        return;
                    }

                    const userName = document.getElementById('user-name').value;
                    const userEmail = document.getElementById('user-email').value;
                    const comment = document.getElementById('review-comment').value;

                    if (!userName || !userEmail || !comment || currentRating === 0) {
                        messageBox.innerHTML = `<p class="text-red-500">Por favor, completa todos los campos y selecciona una calificación.</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);
                        return;
                    }

                    // Mostrar indicador de carga
                    messageBox.innerHTML = `<p class="text-blue-400">Verificando reseña...</p>`;
                    reviewForm.querySelector('button[type="submit"]').disabled = true;

                    // Verificación de lenguaje inapropiado
                    const isFlagged = await checkForProfanity(comment);

                    if (isFlagged) {
                        messageBox.innerHTML = `<p class="text-red-500">Tu reseña contiene lenguaje inapropiado y no puede ser publicada.</p>`;
                        reviewForm.querySelector('button[type="submit"]').disabled = false;
                        setTimeout(() => messageBox.innerHTML = '', 5000);
                        return;
                    }

                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);

                        await addDoc(reviewsCollectionRef, {
                            userId: userId,
                            userName: userName,
                            userEmail: userEmail,
                            rating: currentRating,
                            comment: comment,
                            timestamp: serverTimestamp()
                        });

                        messageBox.innerHTML = `<p class="text-green-500">Reseña enviada con éxito!</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);

                        reviewForm.reset();
                        currentRating = 0;
                        ratingInputs.forEach(input => input.checked = false);

                    } catch (e) {
                        console.error("Error al añadir documento: ", e);
                        messageBox.innerHTML = `<p class="text-red-500">Hubo un error al enviar tu reseña. Inténtalo de nuevo.</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);
                    } finally {
                        reviewForm.querySelector('button[type="submit"]').disabled = false;
                    }
                });
            }

            // Función para cargar y mostrar reseñas en tiempo real
            function loadReviews() {
                if (!isAuthReady) {
                    console.warn("Autenticación no lista para cargar reseñas. Esperando...");
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
                // Firestore no soporta orderBy si no hay un índice compuesto para los campos.
                // Para evitar errores de índice, cargaremos y ordenaremos en el cliente.
                // Si tienes un gran volumen de reseñas, considera crear un índice en Firebase Console para 'timestamp'.
                const q = query(reviewsCollectionRef); // Sin orderBy aquí para evitar errores de índice por defecto

                onSnapshot(q, (snapshot) => {
                    reviewsList.innerHTML = '';
                    if (snapshot.empty) {
                        reviewsList.innerHTML = `<p class="text-gray-400 text-center">Aún no hay reseñas. ¡Sé el primero en dejar una!</p>`;
                        return;
                    }

                    let reviewsData = [];
                    snapshot.forEach((doc) => {
                        reviewsData.push({ id: doc.id, ...doc.data() });
                    });

                    // Ordenar las reseñas por timestamp en el cliente (más reciente primero)
                    reviewsData.sort((a, b) => {
                        if (!a.timestamp || !b.timestamp) return 0; // Manejar reseñas sin timestamp
                        return b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime();
                    });

                    reviewsData.forEach((review) => {
                        const reviewElement = document.createElement('div');
                        reviewElement.className = 'bg-byte-secondary-dark p-6 rounded-lg shadow-md mb-4';
                        reviewElement.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <p class="font-bold text-byte-accent-cyan mr-2">${review.userName}</p>
                                    <div class="text-yellow-400">${'⭐'.repeat(review.rating)}</div>
                                </div>
                                ${userId === adminUserId ? `<button class="delete-review-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded-full transition duration-300" data-id="${review.id}">Eliminar</button>` : ''}
                            </div>
                            <p class="text-gray-300 italic mb-2">${review.comment}</p>
                            <p class="text-gray-500 text-sm">${review.timestamp ? new Date(review.timestamp.toDate()).toLocaleDateString() : 'Fecha desconocida'}</p>
                        `;
                        reviewsList.appendChild(reviewElement);
                    });

                    // Añadir event listeners a los botones de eliminar después de que se rendericen
                    if (userId === adminUserId) {
                        document.querySelectorAll('.delete-review-btn').forEach(button => {
                            button.addEventListener('click', (event) => {
                                reviewToDeleteId = event.target.dataset.id;
                                confirmModal.classList.add('show-modal-active');
                                setTimeout(() => confirmModal.classList.add('show-modal'), 10);
                            });
                        });
                    }

                }, (error) => {
                    console.error("Error al escuchar reseñas: ", error);
                    reviewsList.innerHTML = `<p class="text-red-500 text-center">Error al cargar las reseñas. Por favor, recarga la página.</p>`;
                });
            }

            // Manejo del modal de confirmación de eliminación
            confirmDeleteButton.addEventListener('click', async () => {
                if (reviewToDeleteId) {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const reviewDocRef = doc(db, `artifacts/${appId}/public/data/reviews`, reviewToDeleteId);
                        await deleteDoc(reviewDocRef);
                        messageBox.innerHTML = `<p class="text-green-500">Reseña eliminada con éxito.</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);
                    } catch (error) {
                        console.error("Error al eliminar la reseña: ", error);
                        messageBox.innerHTML = `<p class="text-red-500">Error al eliminar la reseña. Inténtalo de nuevo.</p>`;
                        setTimeout(() => messageBox.innerHTML = '', 3000);
                    } finally {
                        reviewToDeleteId = null;
                        confirmModal.classList.remove('show-modal');
                        setTimeout(() => confirmModal.classList.remove('show-modal-active'), 300);
                    }
                }
            });

            cancelDeleteButton.addEventListener('click', () => {
                reviewToDeleteId = null;
                confirmModal.classList.remove('show-modal');
                setTimeout(() => confirmModal.classList.remove('show-modal-active'), 300);
            });

            // Cerrar modal al hacer clic fuera
            confirmModal.addEventListener('click', (event) => {
                if (event.target === confirmModal) {
                    reviewToDeleteId = null;
                    confirmModal.classList.remove('show-modal');
                    setTimeout(() => confirmModal.classList.remove('show-modal-active'), 300);
                }
            });
        });
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 2rem;
            color: #4A5568; /* Color gris para estrellas no seleccionadas */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label {
            color: #F6E05E; /* Color amarillo para estrellas seleccionadas y las anteriores */
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #F6E05E; /* Color amarillo al pasar el ratón */
        }
        .star-rating input[type="radio"]:checked + label:hover,
        .star-rating input[type="radio"]:checked + label:hover ~ label {
            color: #F6E05E; /* Asegura el color amarillo al pasar el ratón sobre una estrella ya seleccionada */
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* Para que las estrellas se ordenen de derecha a izquierda */
            justify-content: center;
        }

        /* Estilos para el modal de confirmación */
        #confirm-modal {
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }
        #confirm-modal.show-modal {
            opacity: 1;
        }
        #confirm-modal.show-modal-active {
            display: flex;
            pointer-events: auto;
        }
        #confirm-modal > div {
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }
        #confirm-modal.show-modal > div {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-byte-dark-bg text-byte-text-light min-h-screen flex flex-col">

    <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-4 my-8 relative transform transition-all text-byte-dark-bg text-center">
            <h3 class="text-2xl font-bold mb-4">¿Estás seguro?</h3>
            <p class="mb-6">Esta acción eliminará la reseña de forma permanente.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-button" class="bg-gray-300 hover:bg-gray-400 text-byte-dark-bg font-bold py-2 px-4 rounded-full transition duration-300">
                    Cancelar
                </button>
                <button id="confirm-delete-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition duration-300">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <header class="bg-byte-dark-bg shadow-lg py-4 sticky top-0 z-50 border-b border-byte-accent-cyan">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="flex items-center" aria-label="Go to main page">
                    <span class="text-4xl font-extrabold text-byte-accent-cyan block">Byte</span>
                </a>
                <span class="font-vision text-gray-100 text-sm md:text-lg font-light animate-subtle-fade">Tu visión, nuestra misión</span>
            </div>
            <a href="index.html#contacto" class="bg-yellow-500 text-black font-bold py-2 px-6 rounded-full
                                       shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                ¡Volver al Inicio!
            </a>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <h1 class="text-5xl md:text-6xl font-extrabold text-center text-byte-accent-cyan mb-12"
            data-aos="fade-up" data-aos-duration="1000">Reseñas de Clientes</h1>

        <section class="bg-byte-secondary-dark p-8 rounded-xl shadow-2xl max-w-2xl mx-auto mb-12"
            data-aos="fade-up" data-aos-delay="200" data-aos-duration="1000">
            <h2 class="text-3xl font-bold text-center text-byte-accent-cyan mb-8">Deja tu Reseña</h2>
            <form id="review-form" class="space-y-6">
                <div>
                    <label for="user-name" class="block text-lg font-semibold text-byte-text-light mb-2">Tu Nombre</label>
                    <input type="text" id="user-name" name="userName" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan focus:border-transparent" placeholder="Tu nombre" required>
                </div>
                <div>
                    <label for="user-email" class="block text-lg font-semibold text-byte-text-light mb-2">Tu Correo Electrónico</label>
                    <input type="email" id="user-email" name="userEmail" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan focus:border-transparent" placeholder="tu.correo@ejemplo.com" required>
                </div>
                <div>
                    <label class="block text-lg font-semibold text-byte-text-light mb-2">Calificación</label>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 estrellas">★</label>
                        <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 estrellas">★</label>
                        <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 estrellas">★</label>
                        <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 estrellas">★</label>
                        <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 estrella">★</label>
                    </div>
                </div>
                <div>
                    <label for="review-comment" class="block text-lg font-semibold text-byte-text-light mb-2">Tu Comentario</label>
                    <textarea id="review-comment" name="comment" rows="5" class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan focus:border-transparent" placeholder="Comparte tu experiencia..." required></textarea>
                </div>
                <button type="submit" class="w-full bg-byte-accent-cyan text-byte-dark-bg font-bold py-3 px-6 rounded-full shadow-lg hover:bg-yellow-400 transition duration-300 transform hover:scale-105 text-lg">
                    Enviar Reseña
                </button>
                <div id="message-box" class="mt-4 text-center text-sm text-gray-400"></div>
            </form>
            <div class="mt-8 p-4 bg-gray-700 rounded-lg text-gray-300 text-center text-sm">
                <p>⚠️ Por favor, modera tu lenguaje. Todas las reseñas son verificadas para asegurar un ambiente respetuoso.</p>
            </div>
        </section>

        <section class="max-w-3xl mx-auto"
            data-aos="fade-up" data-aos-delay="400" data-aos-duration="1000">
            <h2 class="text-3xl font-bold text-center text-byte-accent-cyan mb-8">Reseñas Recientes</h2>
            <div id="reviews-list" class="space-y-6">
                <p class="text-gray-400 text-center">Cargando reseñas...</p>
            </div>
        </section>
    </main>

    <footer class="bg-byte-dark-bg text-byte-text-light py-6 border-t border-byte-accent-cyan mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm text-gray-400">© <span id="current-year-footer"></span> Byte. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            once: true,
            duration: 1000,
            easing: 'ease-in-out',
        });

        document.getElementById('current-year-footer').textContent = new Date().getFullYear();
    </script>
</body>
</html>
